# Claude Code ベストプラクティス

[Claude Code公式ドキュメントのベストプラクティス](https://code.claude.com/docs/en/best-practices)に基づくレビュー観点とチェック項目。

**核心原則**: コンテキストウィンドウが最も重要なリソース。LLM性能はコンテキストが埋まるにつれ劣化する。

## ベストプラクティス全項目

### カテゴリ1: 検証方法の提供（Verification）

**最も効果の高いプラクティス**: テスト、スクリーンショット、期待出力を提供してClaudeが自己チェックできるようにする。

| 戦略 | Before | After |
|:--|:--|:--|
| **検証基準の提供** | "メールアドレスを検証する関数を実装して" | "validateEmail関数を書いて。テストケース: valid@email.com は true、invalid は false。実装後にテストを実行して" |
| **UI変更の視覚的検証** | "ダッシュボードを良くして" | "[スクリーンショット貼り付け] このデザインを実装。結果のスクリーンショットを撮って元と比較。差異をリストして修正" |
| **根本原因の対処** | "ビルドが失敗している" | "ビルドがこのエラーで失敗: [エラー]。修正してビルド成功を確認。エラーを抑制せず根本原因に対処" |

**検証ツール**: テストスイート、リンター、出力をチェックするBashコマンド、Claude in Chrome拡張（UI検証）

### カテゴリ2: ワークフロー設計（Workflow）

**4フェーズワークフロー**:

1. **Explore**（Plan Mode）: ファイルを読み、コードベースを理解
2. **Plan**（Plan Mode）: 詳細な実装計画を作成。`Ctrl+G` でテキストエディタで計画を直接編集可能
3. **Implement**（Normal Mode）: 計画に基づいてコーディング
4. **Commit**: 記述的なメッセージでコミット・PR作成

**スキップ可能な条件**（差分を1文で説明できる場合）: タイポ修正、ログ行の追加、変数のリネーム

**計画が必要な条件**: アプローチが不確実、複数ファイルの変更、修正対象のコードに不慣れ

### カテゴリ3: コンテキストの提供（Context）

| 戦略 | Before | After |
|:--|:--|:--|
| **スコープを限定** | "foo.pyにテストを追加して" | "foo.pyのテストを書いて。ユーザーがログアウトしているエッジケースをカバー。モックは避けて" |
| **ソースを指定** | "なぜExecutionFactoryのAPIは変なの?" | "ExecutionFactoryのgit履歴を調べてAPIがどう進化したかまとめて" |
| **既存パターンを参照** | "カレンダーウィジェットを追加して" | "ホームページの既存ウィジェット実装を見てパターンを理解。HotDogWidget.phpが良い例。そのパターンに従って実装" |
| **症状を説明** | "ログインバグを直して" | "セッションタイムアウト後にログインが失敗。src/auth/の認証フロー、特にトークンリフレッシュを確認。問題を再現する失敗テストを書いてから修正" |

**曖昧なプロンプトの活用**: 探索的な場合は有効。`"このファイルで何を改善する？"` のような問いかけは予想外の発見につながる。

**Rich Content**: `@` でファイル参照、画像を直接貼り付け、URLを提供（`/permissions`で頻用ドメインを許可リスト登録）、データをパイプ（`cat error.log | claude`）

### カテゴリ4: 環境設定と拡張（Configure your environment）

**CLAUDE.md**:
- `/init` でスタータファイルを自動生成可能
- 短く人間が読みやすく保つ
- 各行で「これを削除したらClaudeが間違える？」と自問
- 重要なルールには強調（`IMPORTANT`, `YOU MUST`）を使用
- `@path/to/import` 構文で他ファイルをインポート
- gitにチェックインしてチームで共有

| 含めるべき内容 | 含めるべきでない内容 |
|:--|:--|
| Claudeが推測できないBashコマンド | コードを読めばわかること |
| デフォルトと異なるコードスタイルルール | 標準的な言語規約 |
| テスト手順と推奨テストランナー | 詳細なAPIドキュメント（リンクで代用） |
| リポジトリエチケット | 頻繁に変更される情報 |
| アーキテクチャ決定 | 長い説明やチュートリアル |
| 開発環境の癖 | ファイルごとのコードベース説明 |
| 一般的な落とし穴 | "クリーンなコードを書く"のような自明な慣行 |

**パーミッション設定**:
- `/permissions` で安全なコマンドを許可リスト登録
- `/sandbox` でOSレベルの分離
- `--dangerously-skip-permissions` はインターネットアクセスのないコンテナでのみ使用

**CLIツール**: `gh`, `aws`, `gcloud`, `sentry-cli` などを活用。最もコンテキスト効率が良い方法。Claudeは未知のツールも学習可能。

**MCPサーバー**: `claude mcp add` で外部ツール（Notion、Figma、データベース等）を接続。

**Hooks**: CLAUDE.mdと異なり**決定論的で実行が保証**される。Claudeにフック作成を依頼可能。`/hooks` で対話的に設定。

**Skills**: `.claude/skills/` に `SKILL.md` を作成。ドメイン知識とワークフローを提供。`disable-model-invocation: true` で手動呼び出し専用に設定可能。

**Subagents**: `.claude/agents/` に専門エージェントを定義。独自のコンテキスト・allowed-toolsを持つ。

**Plugins**: `/plugin` でマーケットプレイスを閲覧。Code Intelligenceプラグインで精密なシンボルナビゲーションと自動エラー検出が可能。

**機能選択ガイド**:

| 目的 | 機能 |
|:--|:--|
| ドメイン知識、再利用可能なワークフロー | Skills |
| 決定論的で常に実行されるアクション | Hooks |
| 分離されたタスク調査 | Subagents |
| 外部統合（データベース、Figmaなど） | MCP servers |
| バンドルされたskills + hooks + 統合 | Plugins |

### カテゴリ5: コミュニケーション（Communicate effectively）

**コードベースへの質問**: シニアエンジニアに聞くようにClaudeに質問。特別なプロンプティング不要。

**インタビュー手法**: 大きな機能では、まずClaudeにインタビューさせる（`AskUserQuestion` ツール使用）。

1. 最小限の初期プロンプトを提供
2. Claudeが技術実装、UI/UX、エッジケース、トレードオフについて質問
3. 完全にカバーするまで続行
4. ClaudeがSPEC.mdに仕様を記述
5. クリーンなコンテキストで新しいセッションを開始して実装

### カテゴリ6: セッション管理（Manage your session）

- **`Esc`**: 処理中に停止（コンテキスト保持）
- **`Esc + Esc` または `/rewind`**: チェックポイントメニューを開く
- **`/clear`**: 無関係なタスク間でコンテキストをリセット
- **ルール**: 同じ問題で2回以上修正したら、`/clear`して学んだことを含むより良いプロンプトで再開

**コンテキスト管理**:
- `/clear` を頻繁に使用
- `/compact <instructions>` でより細かい制御（例: `/compact Focus on the API changes`）
- CLAUDE.mdでコンパクト動作をカスタマイズ可能

**サブエージェント**: 調査を委任してメインの会話をクリーンに保つ。実装後の検証にも使用可能。

**チェックポイント**: 各アクションが自動でチェックポイント作成。会話のみ、コードのみ、または両方を復元可能。セッション間で持続。

**会話の再開**: `claude --continue` / `claude --resume`。`/rename` でセッション名を付ける。

### カテゴリ7: 自動化とスケーリング（Automate and scale）

- **ヘッドレスモード**: `claude -p "prompt"` でCI、pre-commitフック、スクリプト用。`--output-format stream-json` でストリーミングJSON出力。
- **複数セッション**: Claude Desktop（ローカル）やClaude Code on the web（クラウド）で並列セッション。Writer-Reviewerパターンで品質向上。
- **大規模マイグレーション**: タスクをループして `claude -p` を呼び出し、`--allowedTools` でスコープ限定。
- **Safe Autonomous Mode**: `--dangerously-skip-permissions` で全許可チェックをバイパス。インターネットアクセスのないコンテナで使用。`/sandbox` でより安全な自律動作が可能。

### カテゴリ8: 一般的な失敗パターンの回避（Avoid common failure patterns）

| パターン | 問題 | 修正方法 |
|:--|:--|:--|
| **キッチンシンクセッション** | コンテキストが無関係な情報で埋まる | 無関係なタスク間で `/clear` |
| **繰り返し修正** | Claudeが同じ間違いを繰り返す | 2回修正したら `/clear` して最初から |
| **過度なCLAUDE.md** | 長すぎてClaudeが重要ルールを無視 | プルーニングするかhooksに変換 |
| **信頼→検証ギャップ** | エッジケースを扱わない | 常に検証を提供。検証できなければ出荷しない |
| **無限探索** | スコープ限定なしで何百ものファイルを読む | スコープ限定またはサブエージェント使用 |

### カテゴリ9: 直感を磨く（Develop your intuition）

- パターンは出発点であり、状況に応じて判断する
- Claudeが良い出力を出した時、何をしたかを観察する（プロンプト構造、提供したコンテキスト、モード）
- Claudeが苦戦した時、理由を問う（コンテキストがノイジー？プロンプトが曖昧？タスクが大きすぎ？）

## レビュー観点

### 観点1: 検証方法の提供

- タスク完了時の検証方法が定義されているか
- テスト実行、スクリーンショット比較、期待出力などの具体的な検証手段があるか
- エラー発生時に根本原因への対処を促しているか

### 観点2: ワークフロー設計

- Explore → Plan → Implement のフェーズ分離を促進しているか
- 複雑なタスクで計画フェーズを推奨しているか
- 小さなタスクでの不要な計画を強制していないか

### 観点3: コンテキストの具体性

- スコープが明確に限定されているか
- 既存パターンへの参照があるか
- 曖昧な指示を許容していないか（Vibe Coding防止）

### 観点4: インタビュー手法

- 大きな機能で `AskUserQuestion` を活用して仕様を引き出しているか
- 仕様をドキュメントに記録しているか

### 観点5: 拡張機能の設計

- **Skills**: ドメイン知識が構造化されているか、`$ARGUMENTS` で引数を受け取っているか
- **Hooks**: 決定論的に実行されるべきアクションがHooksとして実装されているか
- **Subagents**: allowed-toolsが最小限か、再委譲を避ける設計か
- **CLAUDE.md**: Claudeが推測できない情報のみか、短く読みやすいか

### 観点6: セッション管理

- 重い処理をサブエージェントに委任しているか
- メインコンテキストの汚染を防ぐ設計か

### 観点7: 失敗パターン回避

- 無限探索を防ぐスコープ限定があるか
- 検証なしでの完了を許容していないか

**Red flags**: "全てのファイルを探索"、"包括的に分析"（スコープ限定なし）、検証ステップの欠如、非常に長いプロンプト
