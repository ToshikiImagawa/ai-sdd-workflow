# Claude Code 拡張機能ガイド

[Claude Code公式ドキュメントのFeatures Overview](https://code.claude.com/docs/en/features-overview)に基づく拡張機能の選択・設計レビュー観点。

## 拡張機能一覧

| 機能            | 役割                              | 使用タイミング                  | 例                           |
|:--------------|:--------------------------------|:-------------------------|:----------------------------|
| **CLAUDE.md** | 毎セッション読み込まれる永続コンテキスト            | プロジェクト規約、「常にXする」ルール      | "pnpmを使用。コミット前にテスト実行"       |
| **Skill**     | Claudeが使用できる知識・ワークフロー           | 再利用可能なコンテンツ、リファレンス、反復タスク | `/review` でコードレビューチェックリスト実行 |
| **Subagent**  | 要約結果を返す分離された実行コンテキスト            | コンテキスト分離、並列タスク、専門ワーカー    | 多数のファイルを読む調査タスク             |
| **MCP**       | 外部サービスへの接続                      | 外部データやアクション              | データベースクエリ、Slack投稿、ブラウザ制御    |
| **Hook**      | イベントで実行される決定論的スクリプト             | 予測可能な自動化、LLM不要           | ファイル編集後にESLint実行            |
| **Plugin**    | skills、hooks、subagents、MCPをバンドル | リポジトリ間での再利用、マーケットプレイス配布  | `/my-plugin:review`         |

**Plugins**はパッケージングレイヤー。Plugin内のskillsは名前空間化される（`plugin-name:skill-name`）。

## 類似機能の比較

### Skills vs Subagents

| 観点        | Skill                  | Subagent             |
|:----------|:-----------------------|:---------------------|
| **本質**    | 再利用可能な指示・知識・ワークフロー     | 独自コンテキストを持つ分離されたワーカー |
| **主な利点**  | コンテキスト間でコンテンツを共有       | コンテキスト分離、作業は別で行われる   |
| **最適な用途** | リファレンス資料、呼び出し可能なワークフロー | 多数のファイルを読むタスク、並列作業   |

- **Skillsはリファレンスまたはアクション**: リファレンスSkillはセッション全体で知識を提供（API
  スタイルガイド等）、アクションSkillは特定のタスクを実行（`/deploy`等）
- **Subagentを使うべき場面**: コンテキスト分離が必要な時、またはコンテキストウィンドウが満杯に近い時。中間作業をメインに残す必要がない場合にも有効
- **組み合わせ可能**: Subagentは`skills:`フィールドでスキルをプリロード可能。Skillは`context: fork`で分離コンテキストで実行可能
- **Skill Description の重要性**: 曖昧または重複するdescriptionは誤ったスキル選択の原因。確実に特定のスキルを使いたい場合は
  `/<name>` で明示的に呼び出す

### CLAUDE.md vs Skill

| 観点             | CLAUDE.md        | Skill                  |
|:---------------|:-----------------|:-----------------------|
| **読み込み**       | 毎セッション、自動的に      | オンデマンド                 |
| **ファイル含有**     | `@path` インポートで可能 | `@path` インポートで可能       |
| **ワークフロートリガー** | 不可               | `/<name>`で可能           |
| **最適な用途**      | 「常にXする」ルール       | リファレンス資料、呼び出し可能なワークフロー |

- CLAUDE.mdは約500行以下に維持、リファレンスコンテンツはskillsに移動

### MCP vs Skill

| 観点         | MCP                  | Skill                     |
|:-----------|:---------------------|:--------------------------|
| **本質**     | 外部サービス接続用プロトコル       | 知識、ワークフロー、リファレンス資料        |
| **提供するもの** | ツールとデータアクセス          | 知識、ワークフロー、リファレンス資料        |
| **例**      | Slack連携、DBクエリ、ブラウザ制御 | コードレビューチェックリスト、デプロイワークフロー |

- **MCP**: 外部システムとの対話能力を提供
- **Skills**: ツールの効果的な使い方を教える + ワークフローをトリガー
- 例: MCPサーバーがDBに接続、Skillがデータモデルとクエリパターンを文書化

## 機能のレイヤリング

| 機能                   | 動作         | 詳細                                                                                         |
|:---------------------|:-----------|:-------------------------------------------------------------------------------------------|
| **CLAUDE.md**        | **加算的**    | すべてのレベルが同時にコンテンツを提供。矛盾時はClaudeが判断、より具体的なものが優先                                              |
| **Skills/Subagents** | **名前で上書き** | managed > user > project (Skills)、managed > CLI flag > project > user > plugin (Subagents) |
| **MCP**              | **名前で上書き** | local > project > user                                                                     |
| **Hooks**            | **マージ**    | すべての登録済みhooksがマッチするイベントで発火                                                                 |

## コンテキストコスト

| 機能              | 読み込みタイミング      | 読み込み内容                                                       | コスト           |
|:----------------|:---------------|:-------------------------------------------------------------|:--------------|
| **CLAUDE.md**   | セッション開始時       | 全コンテンツ（作業ディレクトリからルートまで。サブディレクトリはアクセス時）                       | 毎リクエスト        |
| **Skills**      | セッション開始時 + 使用時 | 開始時は説明のみ、使用時に全コンテンツ                                          | 低（説明は毎リクエスト）* |
| **MCP servers** | セッション開始時       | 全ツール定義とスキーマ（Tool searchで最大10%まで読み込み、残りはオンデマンド）               | 毎リクエスト        |
| **Subagents**   | 起動時            | 新しい分離コンテキスト: システムプロンプト + skills全コンテンツ + CLAUDE.md + gitステータス | メインセッションから分離  |
| **Hooks**       | トリガー時          | なし（外部で実行）                                                    | ゼロ（出力を返さない限り） |

*`disable-model-invocation: true`設定時はClaudeから完全に隠れコストゼロ。
*Subagent内ではskillsは起動時に完全プリロード（メインセッションのskillsは継承しない）。

**MCP信頼性の注意**: MCP接続はセッション中に静かに失敗する可能性あり。Claudeが存在しないツールを使用しようとする場合あり。
`/mcp`で確認。

### 組み合わせパターン

| パターン                   | 仕組み                                   | 例                                           |
|:-----------------------|:--------------------------------------|:--------------------------------------------|
| **Skill + MCP**        | MCPが接続を提供、Skillが使い方を教える               | MCPがDBに接続、Skillがスキーマを文書化                    |
| **Skill + Subagent**   | Skillが並列作業のためにsubagentsを起動            | `/review` skillがセキュリティ、パフォーマンスのsubagentsを起動 |
| **CLAUDE.md + Skills** | CLAUDE.mdが常時オンルール、Skillsがオンデマンドリファレンス | CLAUDE.md: "API規約に従う"、Skillが完全なスタイルガイド      |
| **Hook + MCP**         | HookがMCP経由で外部アクションをトリガー               | 編集後hookがSlack通知を送信                          |

## レビュー観点

### 観点1: 機能選択の適切性

- 目的に対して適切な機能が選択されているか
- 「常にXする」ルールはCLAUDE.mdに記載されているか
- リファレンス資料・ワークフローはSkillsで実装されているか
- 外部サービス連携にはMCPが使用されているか
- 決定論的な自動化にはHooksが使用されているか
- コンテキスト分離が必要なタスクにはSubagentsが使用されているか
- 手動呼び出し専用なら`disable-model-invocation: true`が設定されているか

### 観点2: 機能の組み合わせ

**アンチパターン**:

- MCPツールがあるのにその使い方を教えるSkillがない
- CLAUDE.mdに大量のリファレンス資料が含まれている（Skillsに移動すべき）
- 毎回確実に実行すべき処理がCLAUDE.mdの指示になっている（Hooksにすべき）
- コンテキストを消費する重い処理がメインで実行されている（Subagentsにすべき）

### 観点3: コンテキストコスト最適化

- CLAUDE.mdが約500行以下に維持されているか
- リファレンス資料がCLAUDE.mdからSkillsに分離されているか
- 手動呼び出し専用のSkillsに`disable-model-invocation: true`が設定されているか
- 大量ファイル読み込みタスクがSubagentsに委任されているか
- 未使用のMCPサーバーが接続されていないか（`/mcp`でトークンコスト確認）

### 観点4: レイヤリングの正しい使用

- CLAUDE.mdが加算的に機能することを理解した設計か
- Skills/Subagentsの名前が衝突しないよう設計されているか
- Pluginのskillsが適切に名前空間化されているか（`plugin-name:skill-name`）
- Hooksが複数ソースからマージされることを考慮しているか
