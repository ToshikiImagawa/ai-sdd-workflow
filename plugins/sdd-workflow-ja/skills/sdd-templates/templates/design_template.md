# {機能名} 技術設計書

## 文書情報

| 項目       | 内容                                                                                  |
|:---------|:------------------------------------------------------------------------------------|
| 機能名      | {機能名}                                                                               |
| 作成日      | YYYY-MM-DD                                                                          |
| 実装ステータス  | 未実装 / 実装中 / 実装完了 / テスト中 / 完了                                                        |
| 関連ドキュメント | [PRD](.docs/requirement-diagram/{機能名}.md), [仕様書](.docs/specification/{機能名}_spec.md) |

## 設計目標

### 主要目標

1. {達成すべき技術目標1}
2. {達成すべき技術目標2}
3. {達成すべき技術目標3}

### 品質属性

| 属性       | 目標        | 測定方法   |
|:---------|:----------|:-------|
| パフォーマンス  | {具体的な目標値} | {測定方法} |
| スケーラビリティ | {具体的な目標値} | {測定方法} |
| 保守性      | {具体的な目標値} | {測定方法} |
| テスト容易性   | {具体的な目標値} | {測定方法} |

## 技術スタック

### 採用技術

| カテゴリ    | 技術/ライブラリ     | バージョン   | 選定理由   |
|:--------|:-------------|:--------|:-------|
| 言語      | {言語名}        | {バージョン} | {選定理由} |
| フレームワーク | {フレームワーク名}   | {バージョン} | {選定理由} |
| データベース  | {DB名}        | {バージョン} | {選定理由} |
| テスト     | {テストフレームワーク} | {バージョン} | {選定理由} |
| その他     | {ライブラリ名}     | {バージョン} | {選定理由} |

### 依存関係

```mermaid
graph TD
subgraph "本機能"
A[{機能名}]
end

subgraph "内部依存"
B[{依存モジュール1}]
C[{依存モジュール2}]
end

subgraph "外部依存"
D[{外部サービス1}]
E[{外部ライブラリ1}]
end

A --> B
A --> C
A --> D
A --> E
```

## アーキテクチャ

### システム構成図

```mermaid
graph TB
    subgraph "プレゼンテーション層"
        UI[UI Component]
    end

subgraph "アプリケーション層"
SVC[{機能名}Service]
UC[UseCase]
end

subgraph "ドメイン層"
ENT[Entity]
REPO_IF[Repository Interface]
end

subgraph "インフラストラクチャ層"
REPO[Repository Implementation]
EXT[External Service Client]
end

UI --> SVC
SVC --> UC
UC --> ENT
UC --> REPO_IF
REPO_IF --> REPO
UC --> EXT
```

### モジュール構成

```
src/
├── {機能名}/
│   ├── index.ts                 # 公開API
│   ├── types.ts                 # 型定義
│   ├── {機能名}.service.ts      # サービス層
│   ├── {機能名}.usecase.ts      # ユースケース層
│   ├── domain/
│   │   ├── entities/            # エンティティ
│   │   └── repositories/        # リポジトリインターフェース
│   ├── infrastructure/
│   │   ├── repositories/        # リポジトリ実装
│   │   └── external/            # 外部サービスクライアント
│   └── __tests__/               # テスト
│       ├── unit/
│       └── integration/
```

### レイヤー責務

| レイヤー       | 責務              | 依存可能なレイヤー        |
|:-----------|:----------------|:-----------------|
| プレゼンテーション  | UI、入出力処理        | アプリケーション         |
| アプリケーション   | ユースケースの調整       | ドメイン             |
| ドメイン       | ビジネスロジック、エンティティ | なし（純粋）           |
| インフラストラクチャ | 技術的実装、外部連携      | ドメイン（インターフェース実装） |

## 設計判断

### 決定事項

#### DJ-001: {設計判断タイトル1}

**コンテキスト**: {この判断が必要になった背景}

**決定**: {採用した設計アプローチ}

**理由**:

- {理由1}
- {理由2}

**検討した代替案**:

| 代替案    | メリット   | デメリット   | 却下理由   |
|:-------|:-------|:--------|:-------|
| {代替案1} | {メリット} | {デメリット} | {却下理由} |
| {代替案2} | {メリット} | {デメリット} | {却下理由} |

**影響**:

- {この決定による影響1}
- {この決定による影響2}

#### DJ-002: {設計判断タイトル2}

**コンテキスト**: {背景}

**決定**: {採用した設計}

**理由**:

- {理由}

### 未決定事項

| ID      | 項目      | 選択肢            | 決定期限       | 担当   |
|:--------|:--------|:---------------|:-----------|:-----|
| TBD-001 | {未決定項目} | {選択肢1}, {選択肢2} | YYYY-MM-DD | {担当} |

## データモデル（詳細）

### データベーススキーマ

```sql
-- {テーブル名1}
CREATE TABLE {table_name1}
(
    id
    UUID
    PRIMARY
    KEY
    DEFAULT
    gen_random_uuid
(
),
    {column1} VARCHAR
(
    255
) NOT NULL,
    {column2} INTEGER,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );

-- インデックス
CREATE INDEX idx_{table_name1} _{column1} ON {table_name1}({column1});

-- {テーブル名2}
CREATE TABLE {table_name2}
(
    id
    UUID
    PRIMARY
    KEY
    DEFAULT
    gen_random_uuid
(
),
    {table_name1} _id UUID REFERENCES {table_name1}
(
    id
),
    {column1} TEXT NOT NULL
    );
```

### マイグレーション計画

| バージョン | 変更内容     | 影響   | ロールバック可否 |
|:------|:---------|:-----|:---------|
| v1.0  | 初期スキーマ作成 | なし   | 可能       |
| v1.1  | {変更内容}   | {影響} | 可能/不可能   |

## インターフェース定義（詳細）

### 内部インターフェース

```typescript
// Service Interface
interface I {
    機能名
}

Service
{
    operation1(param
:
    Param1Type
):
    Promise<Result1Type>;
    operation2(param
:
    Param2Type
):
    Promise<Result2Type>;
}

// Repository Interface
interface I {
    Entity
}

Repository
{
    findById(id
:
    string
):
    Promise<{ Entity } | null>;
    save(entity
:
    {
        Entity
    }
):
    Promise<void>;
    delete (id
:
    string
):
    Promise<void>;
}
```

### 外部API（該当する場合）

#### エンドポイント一覧

| メソッド   | パス                  | 説明   | 認証   |
|:-------|:--------------------|:-----|:-----|
| GET    | /api/{resource}     | {説明} | 要/不要 |
| POST   | /api/{resource}     | {説明} | 要/不要 |
| PUT    | /api/{resource}/:id | {説明} | 要/不要 |
| DELETE | /api/{resource}/:id | {説明} | 要/不要 |

#### リクエスト/レスポンス例

```json
// POST /api/{resource}
// Request
{
  "field1": "value1",
  "field2": 123
}

// Response (201 Created)
{
  "id": "uuid",
  "field1": "value1",
  "field2": 123,
  "createdAt": "2024-01-01T00:00:00Z"
}

// Error Response (400 Bad Request)
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "field1 is required"
  }
}
```

## エラーハンドリング

### エラー分類

| エラーコード           | HTTP Status | 説明      | 対応       |
|:-----------------|:------------|:--------|:---------|
| VALIDATION_ERROR | 400         | 入力検証エラー | クライアント修正 |
| UNAUTHORIZED     | 401         | 認証エラー   | 再認証      |
| FORBIDDEN        | 403         | 権限エラー   | 権限確認     |
| NOT_FOUND        | 404         | リソース不在  | 確認       |
| INTERNAL_ERROR   | 500         | 内部エラー   | 再試行/報告   |

### リトライ戦略

| エラー種別      | リトライ | 最大回数 | バックオフ   |
|:-----------|:-----|:-----|:--------|
| ネットワークエラー  | する   | 3    | 指数バックオフ |
| タイムアウト     | する   | 2    | 固定間隔    |
| 認証エラー      | しない  | -    | -       |
| バリデーションエラー | しない  | -    | -       |

## テスト戦略

### テストレベル

| レベル    | 対象       | カバレッジ目標  | ツール          |
|:-------|:---------|:---------|:-------------|
| 単体テスト  | 関数、クラス   | 80%以上    | {テストフレームワーク} |
| 統合テスト  | モジュール間連携 | 主要パス     | {テストフレームワーク} |
| E2Eテスト | ユーザーシナリオ | クリティカルパス | {E2Eツール}     |

### テストケース概要

| テストID  | 対象   | シナリオ      | 期待結果   |
|:-------|:-----|:----------|:-------|
| UT-001 | {対象} | {正常系シナリオ} | {期待結果} |
| UT-002 | {対象} | {異常系シナリオ} | {期待結果} |
| IT-001 | {対象} | {統合シナリオ}  | {期待結果} |

## セキュリティ考慮事項

### 脅威と対策

| 脅威          | リスク   | 対策           |
|:------------|:------|:-------------|
| {脅威1}       | 高/中/低 | {対策}         |
| SQLインジェクション | 高     | パラメータ化クエリの使用 |
| XSS         | 中     | 出力エスケープ      |

### 認証・認可

- 認証方式: {JWT / Session / OAuth など}
- 認可モデル: {RBAC / ABAC など}
- セッション管理: {セッションタイムアウト、リフレッシュ戦略}

## パフォーマンス考慮事項

### ボトルネック予測

| 箇所        | 予測される問題 | 対策            |
|:----------|:--------|:--------------|
| {箇所1}     | {問題}    | {対策}          |
| データベースクエリ | N+1問題   | Eager Loading |

### 最適化戦略

- キャッシュ戦略: {キャッシュ対象、TTL、無効化戦略}
- インデックス戦略: {インデックス対象カラム}
- 非同期処理: {非同期化する処理}

## 実装計画

### マイルストーン

| フェーズ | 内容     | 期間   | 成果物   |
|:-----|:-------|:-----|:------|
| 1    | 基盤実装   | {期間} | {成果物} |
| 2    | コア機能実装 | {期間} | {成果物} |
| 3    | テスト・修正 | {期間} | {成果物} |

### タスク分解（概要）

詳細なタスク分解は `/task_breakdown` コマンドで生成し、`.docs/review/{チケット番号}/` に配置します。

## 仕様書参照

- 対応仕様書: `.docs/specification/{機能名}_spec.md`
- 対応PRD: `.docs/requirement-diagram/{機能名}.md`

### 仕様との対応

| 仕様書要件    | 本設計での実現方法 |
|:---------|:----------|
| SPEC-001 | {実現方法}    |
| SPEC-002 | {実現方法}    |

---

## 変更履歴

| 日付         | バージョン | 変更内容 | 変更者  |
|:-----------|:------|:-----|:-----|
| YYYY-MM-DD | 1.0   | 初版作成 | {名前} |
