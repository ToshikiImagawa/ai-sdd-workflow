---
description: "実装完了後のtask/ディレクトリを整理し、重要な設計判断を*_design.mdに統合してから削除する"
argument-hint: "<チケット番号>"
allowed-tools: Read, Write, Edit, Glob, Grep, Bash, AskUserQuestion
---

# Task Cleanup - タスクログのクリーンアップ

`.sdd/task/` 配下のドキュメントを整理し、重要な設計判断を `.sdd/specification/*_design.md` に統合してから削除します。

## 前提条件

### プラグイン更新チェック

**実行前に `.sdd/UPDATE_REQUIRED.md` の存在を確認してください。**

このファイルが存在する場合、AI-SDDプラグインの更新が必要です。ユーザーに警告を表示し、以下のコマンドを実行するよう促してください：

```
/sdd_init
```

### AI-SDD原則ドキュメントの読み込み

**実行前に AI-SDD原則ドキュメントを読み込んでください。**

AI-SDD原則ドキュメントのパス: `.sdd/AI-SDD-PRINCIPLES.md`

**注意**: このファイルはセッション開始時に自動的に最新化されます。

AI-SDDの原則を理解してください。

このコマンドはAI-SDD原則に従ってクリーンアップを行います。

### ディレクトリパスの解決

**環境変数 `SDD_*` を使用してディレクトリパスを解決します。**

| 環境変数                     | デフォルト値               | 説明              |
|:-------------------------|:---------------------|:----------------|
| `SDD_ROOT`               | `.sdd`               | ルートディレクトリ       |
| `SDD_REQUIREMENT_PATH`   | `.sdd/requirement`   | PRD/要求仕様書ディレクトリ |
| `SDD_SPECIFICATION_PATH` | `.sdd/specification` | 仕様書・設計書ディレクトリ   |
| `SDD_TASK_PATH`          | `.sdd/task`          | タスクログディレクトリ     |

**パス解決の優先順位:**

1. 環境変数 `SDD_*` が設定されている場合はそれを使用
2. 環境変数がない場合は `.sdd-config.json` を確認
3. どちらもない場合はデフォルト値を使用

以下のドキュメントでは、デフォルト値を使用して説明しますが、環境変数または設定ファイルが存在する場合はカスタム値に置き換えてください。

### ドキュメント永続性ルール（参照）

| パス                          | 永続性     | 管理ルール                                   |
|:----------------------------|:--------|:----------------------------------------|
| `specification/*_design.md` | **永続**  | 技術設計、アーキテクチャ、技術選定の根拠を記述                 |
| `task/`                     | **一時的** | 実装完了後に**削除**。重要な設計判断は `*_design.md` に統合 |

## 入力

$ARGUMENTS

### 入力例

```
/task_cleanup TICKET-123
/task_cleanup feature/task-management
/task_cleanup  # 引数なしの場合はtask/全体を対象
```

### 引数なし実行時のスコープ確認

**引数なしで実行された場合、処理を開始する前に対象ディレクトリの内容を表示し、ユーザーに確認を求めてください。**

```markdown
## スコープ確認

引数が指定されていないため、以下の全ディレクトリ/ファイルがクリーンアップ対象となります：

| 種別 | パス | 最終更新日 |
|:--|:--|:--|
| ディレクトリ | .sdd/task/{チケット1}/ | YYYY-MM-DD |
| ディレクトリ | .sdd/task/{チケット2}/ | YYYY-MM-DD |
| ファイル | .sdd/task/{ファイル1}.md | YYYY-MM-DD |
| ... | ... | ... |

**合計: {n}項目**

⚠️ **注意**: クリーンアップは削除を伴う操作です。重要な設計判断は `*_design.md` に統合されますが、統合不要と判断された内容は削除されます。

このスコープでクリーンアップを実行してよろしいですか？
- 特定のディレクトリのみ対象にする場合は、チケット番号を指定して再実行してください
- 例: `/task_cleanup TICKET-123`
```

**確認後の動作**:
- ユーザーが承認 → 全体を対象にクリーンアップを実行
- ユーザーがキャンセルまたは特定ディレクトリを指定 → 指定されたスコープで再実行

## 処理フロー

### 1. 対象ディレクトリの特定

```
引数あり → .sdd/task/{引数}/ を対象
引数なし → .sdd/task/ 全体を対象
```

### 2. 対象ファイルの確認

```bash
# 対象ディレクトリ内のファイル一覧を取得
ls -la .sdd/task/{対象}/

# 各ファイルの最終更新日を確認
git log -1 --format="%ci" -- <file_path>
```

### 3. 内容の分析と分類

各ファイルの内容を確認し、以下のように分類してください：

**統合すべき内容（→ `*_design.md` へ）**:

| カテゴリ              | 例                                 |
|:------------------|:----------------------------------|
| **設計判断とその根拠**     | 「Redisを選択した理由：〜」「このパターンを採用した理由：〜」 |
| **代替案の検討結果**      | 「案A vs 案B の比較検討」「不採用案とその理由」       |
| **技術的なTipsやノウハウ** | 実装時に発見した注意点、パフォーマンス改善のポイント        |
| **トラブルシューティング情報** | 遭遇した問題と解決策                        |
| **再利用可能なパターン**    | 他の機能でも使えるコードパターンや設計パターン           |

**削除して良い内容（移行不要）**:

| カテゴリ         | 例               |
|:-------------|:----------------|
| **作業進捗メモ**   | 「〇〇を実装中」「△△が完了」 |
| **一時的な調査ログ** | 日記的な内容、試行錯誤の記録  |
| **具体的な実装手順** | コードに反映済みの詳細手順   |
| **タスクリスト**   | 完了したタスクの一覧      |
| **日付依存の情報**  | 特定の期間や日時に依存する情報 |

### 4. 統合先の決定

統合する情報がある場合、適切な統合先を決定してください：

```
1. 内容に最も関連する既存の *_design.md を探す
2. 適切な既存ファイルがない場合:
   - 関連する *_spec.md が存在する → 対応する *_design.md を新規作成
   - 関連する *_spec.md がない → 統合をスキップ（情報は削除）
```

### 5. 情報の統合

統合を行う場合：

- 既存セクションに自然に統合するか、新しいセクションを追加
- 出典元のファイル名は記載しない（歴史を残さない）
- 技術設計書のフォーマットに合わせて整形

### 6. ファイル/ディレクトリの削除

```bash
# ファイルの削除
git rm .sdd/task/{対象}/{ファイル}

# ディレクトリごと削除（全ファイル処理完了後）
git rm -r .sdd/task/{対象}/
```

## 出力フォーマット

`output-templates` スキルを使用してクリーンアップ確認メッセージを表示してください。

## 注意事項

### 慎重に判断すべきケース

- **実装が完了していない場合**: task/ は残す
- **統合先が不明確な場合**: ユーザーに確認
- **複数の機能にまたがる情報**: 最も関連性の高いドキュメントに統合

### 削除の原則

- **歴史を残さない**: 移行時に「〜から移行」などの記述は追加しない
- **最小限の移行**: 本当に価値のある情報のみを移行
- **重複を避ける**: 既に `*_design.md` に記載済みの内容は移行しない
