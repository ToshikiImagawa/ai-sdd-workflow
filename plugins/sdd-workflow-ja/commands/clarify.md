---
description: "仕様書の不明点を9カテゴリでスキャンし、最大5つの質問を生成して仕様を明確化する"
argument-hint: "[仕様書ファイルパス]"
allowed-tools: Read, Write, Edit, Glob, Grep, AskUserQuestion
---

# Clarify - 仕様明確化支援

仕様書（`*_spec.md`）の不明点を9カテゴリでスキャンし、高インパクトな質問を生成して仕様を段階的に明確化します。

## 前提条件

### プラグイン更新チェック

**実行前に `.sdd/UPDATE_REQUIRED.md` の存在を確認してください。**

このファイルが存在する場合、AI-SDDプラグインの更新が必要です。ユーザーに警告を表示し、以下のコマンドを実行するよう促してください：

```
/sdd_init
```

### AI-SDD原則ドキュメントの読み込み

**実行前に AI-SDD原則ドキュメントを読み込んでください。**

AI-SDD原則ドキュメントのパス: `.sdd/AI-SDD-PRINCIPLES.md`

**注意**: このファイルはセッション開始時に自動的に最新化されます。

AI-SDDの原則を理解してください。

このコマンドはAI-SDD原則に従って仕様の明確化を支援します。

### ディレクトリパスの解決

**環境変数 `SDD_*` を使用してディレクトリパスを解決します。**

| 環境変数                     | デフォルト値               | 説明              |
|:-------------------------|:---------------------|:----------------|
| `SDD_ROOT`               | `.sdd`               | ルートディレクトリ       |
| `SDD_REQUIREMENT_PATH`   | `.sdd/requirement`   | PRD/要求仕様書ディレクトリ |
| `SDD_SPECIFICATION_PATH` | `.sdd/specification` | 仕様書・設計書ディレクトリ   |
| `SDD_TASK_PATH`          | `.sdd/task`          | タスクログディレクトリ     |

**パス解決の優先順位:**

1. 環境変数 `SDD_*` が設定されている場合はそれを使用
2. 環境変数がない場合は `.sdd-config.json` を確認
3. どちらもない場合はデフォルト値を使用

以下のドキュメントでは、デフォルト値を使用して説明しますが、環境変数または設定ファイルが存在する場合はカスタム値に置き換えてください。

### 補完ツールとの関係

このコマンドは `vibe-detector` スキルと補完関係にあります：

| ツール               | 焦点                   | タイミング     |
|:------------------|:---------------------|:----------|
| **vibe-detector** | 曖昧な指示の検出             | 実装開始前の警告  |
| **clarify**       | 仕様書の不明点の体系的な洗い出しと明確化 | 仕様作成中・更新時 |

## 入力

$ARGUMENTS

### 入力例

```
/clarify user-auth
/clarify auth/user-login                # 階層構造
/clarify task-management --interactive  # 対話モード（質問に1つずつ回答）
```

## 処理フロー

### 1. 対象仕様書の読み込み

フラット構造と階層構造の両方をサポートします。

**フラット構造の場合**:

```
.sdd/requirement/{機能名}.md を読み込む（PRD、存在する場合）
.sdd/specification/{機能名}_spec.md を読み込む（必須）
.sdd/specification/{機能名}_design.md を読み込む（存在する場合）
```

**階層構造の場合**（引数に `/` が含まれる場合）:

```
.sdd/requirement/{親機能名}/{機能名}.md を読み込む（PRD、存在する場合）
.sdd/specification/{親機能名}/{機能名}_spec.md を読み込む（必須）
.sdd/specification/{親機能名}/{機能名}_design.md を読み込む（存在する場合）
```

**⚠️ 命名規則の違いに注意**:

- **requirement 配下**: サフィックスなし（`{機能名}.md`）
- **specification 配下**: `_spec` または `_design` サフィックス必須（`{機能名}_spec.md`）

### 2. 9カテゴリによるスキャン

仕様書を以下の9カテゴリで分析し、不明点を洗い出します：

| カテゴリ          | スキャン対象                     |
|:--------------|:---------------------------|
| **1. 機能範囲**   | スコープ内外の境界が明確か、エッジケースのカバー範囲 |
| **2. データモデル** | 型定義、必須フィールド、制約、データの生存期間    |
| **3. フロー**    | 状態遷移、エラーハンドリング、リトライ戦略      |
| **4. 非機能要件**  | パフォーマンス目標、スケーラビリティ、セキュリティ  |
| **5. 統合**     | 外部システム連携、API契約、依存関係        |
| **6. エッジケース** | 例外処理、境界値、データ欠損時の振る舞い       |
| **7. 制約**     | 技術的制約、ビジネス制約、規制要件          |
| **8. 用語**     | ドメイン固有用語の定義、略語、曖昧な表現       |
| **9. 完了条件**   | 受け入れ基準、テストシナリオ、成功の定義       |

### 3. 不明確度の分類

各カテゴリの項目を以下の3段階で評価：

| ステータス          | 評価          | 説明           |
|:---------------|:------------|:-------------|
| **🟢 Clear**   | 明確に定義されている  | 問題なし         |
| **🟡 Partial** | 部分的に定義されている | 補足が推奨される     |
| **🔴 Missing** | 未定義または曖昧    | 実装前に必ず明確化が必要 |

### 4. 質問の優先順位付け

不明点から最大5つの高インパクト質問を生成：

**質問選定基準**:

| 基準        | 説明                  |
|:----------|:--------------------|
| **影響度**   | 複数のモジュール・機能に影響するか   |
| **リスク**   | 不明確なまま実装すると手戻りが大きいか |
| **ブロッカー** | 実装開始の前提となる情報か       |
| **依存性**   | 他の設計判断に影響を与えるか      |

## 出力フォーマット

`output-templates` スキルを使用して仕様明確化レポートを表示してください。

## 対話モード（--interactive）

`--interactive` オプションを指定すると、質問に1つずつ回答できます：

```
1. 質問を1つ表示
   ↓
2. ユーザーが回答
   ↓
3. 回答を仕様書に統合
   ↓
4. 次の質問へ（または完了）
```

### 対話モードの利点

- 質問を見ながら段階的に考えられる
- 回答後すぐに仕様書が更新される
- 長い質問リストに圧倒されない

## 更新の推奨タイミング

| タイミング      | 目的              |
|:-----------|:----------------|
| **仕様作成直後** | 初期段階での不明点の洗い出し  |
| **実装開始前**  | 最終確認、残りの不明点をゼロに |
| **仕様変更時**  | 変更による新たな不明点の検出  |
| **レビュー時**  | 第三者視点での不明点の発見   |

## vibe-detector との使い分け

| ツール               | 使用タイミング    | 検出対象      |
|:------------------|:-----------|:----------|
| **vibe-detector** | 実装指示を受けた直後 | 曖昧な指示そのもの |
| **clarify**       | 仕様書作成中・更新時 | 仕様書内の不明点  |

**推奨ワークフロー**:

```
1. ユーザーからタスクを受ける
   ↓
2. vibe-detector で曖昧な指示を検出
   ↓
3. 仕様書を作成/更新
   ↓
4. clarify で不明点をスキャン
   ↓
5. 質問に回答して仕様を明確化
   ↓
6. 明確度スコア 80% 以上で実装開始
```

## 明確化後の検証

### 自動検証（実行済み）

明確化プロセス中に以下が自動実行されます：

- [x] **9カテゴリスキャン**: 機能範囲、データモデル、フロー等の不明点を網羅的に検出
- [x] **明確度スコア算出**: Clear/Partial/Missing の分類と総合スコアを計算
- [x] **質問の優先順位付け**: 影響度・リスク・ブロッカー度に基づいて質問を選定

### 推奨する手動検証

- [ ] 総合スコアが 80% 以上であることを確認
- [ ] Missing（🔴）項目がすべて解消されていることを確認
- [ ] 回答内容が仕様書に正しく統合されていることを確認

### 検証コマンド

```bash
# 再スキャンして明確度を再確認
/clarify {機能名}

# 整合性チェック（更新後の仕様書を検証）
/check_spec {機能名} --full
```

### 実装開始の判断基準

| 明確度スコア | 推奨アクション |
|:---|:---|
| 80% 以上 | 実装開始可能 |
| 60-79% | Partial 項目の解消を推奨 |
| 60% 未満 | 実装開始前にさらなる明確化が必要 |

## 注意事項

- 仕様書が存在しない場合は、先に `/generate_spec` で作成を推奨
- 明確度スコア 80% 未満での実装開始はリスクが高い
- 回答が得られない質問は `task/` に「未解決の質問」として記録
- 回答を仕様書に統合する際は、命名規則（`_spec` サフィックス）に注意