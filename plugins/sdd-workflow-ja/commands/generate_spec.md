---
description: "入力された内容から抽象仕様書（Specification）と技術設計書（Design Doc）を生成する"
allowed-tools: Read, Write, Edit, Glob, Grep, Bash, AskUserQuestion
---

# Specification & Design Doc Generator

入力された内容から AI-SDD ワークフローに従って以下のドキュメントを生成します：

1. `.sdd/specification/{機能名}_spec.md` - 抽象仕様書（Specify フェーズ）
2. `.sdd/specification/{機能名}_design.md` - 技術設計書（Plan フェーズ）

## 前提条件

### プラグイン更新チェック

**実行前に `.sdd/UPDATE_REQUIRED.md` の存在を確認してください。**

このファイルが存在する場合、AI-SDDプラグインの更新が必要です。ユーザーに警告を表示し、以下のコマンドを実行するよう促してください：

```
/sdd_init
```

### AI-SDD原則ドキュメントの読み込み

**実行前に AI-SDD原則ドキュメントを読み込んでください。**

AI-SDD原則ドキュメントのパス: `.sdd/AI-SDD-PRINCIPLES.md`

**注意**: このファイルはセッション開始時に自動的に最新化されます。

AI-SDDの原則を理解してください。

このコマンドはAI-SDD原則に従って仕様書・設計書を生成します。

### ディレクトリパスの解決

**環境変数 `SDD_*` を使用してディレクトリパスを解決します。**

| 環境変数                     | デフォルト値               | 説明              |
|:-------------------------|:---------------------|:----------------|
| `SDD_ROOT`               | `.sdd`               | ルートディレクトリ       |
| `SDD_REQUIREMENT_PATH`   | `.sdd/requirement`   | PRD/要求仕様書ディレクトリ |
| `SDD_SPECIFICATION_PATH` | `.sdd/specification` | 仕様書・設計書ディレクトリ   |
| `SDD_TASK_PATH`          | `.sdd/task`          | タスクログディレクトリ     |

**パス解決の優先順位:**

1. 環境変数 `SDD_*` が設定されている場合はそれを使用
2. 環境変数がない場合は `.sdd-config.json` を確認
3. どちらもない場合はデフォルト値を使用

以下のドキュメントでは、デフォルト値を使用して説明しますが、環境変数または設定ファイルが存在する場合はカスタム値に置き換えてください。

### 使用するスキル

このコマンドは以下のスキルを使用します：

| スキル                             | 用途                                                                                       |
|:--------------------------------|:-----------------------------------------------------------------------------------------|
| `sdd-workflow-ja:sdd-templates` | プロジェクトテンプレートが存在しない場合に `.sdd/SPECIFICATION_TEMPLATE.md`、`.sdd/DESIGN_DOC_TEMPLATE.md` を生成 |

**テンプレート準備フロー**:

1. `.sdd/SPECIFICATION_TEMPLATE.md`、`.sdd/DESIGN_DOC_TEMPLATE.md`（プロジェクトテンプレート）が存在すれば使用
2. 存在しない場合は `sdd-templates` スキルを使用してテンプレートを生成

### 生成前確認事項

生成前に以下を確認してください：

1. プロジェクトに `.sdd/` ディレクトリが存在するか
2. テンプレートファイルが存在する場合はそれを使用

## 入力

$ARGUMENTS

## 入力例

```
/generate_spec ユーザー認証機能。
メールアドレスとパスワードによるログイン・ログアウトに対応。
パスワードリセット機能を提供し、セッション管理はJWTトークンで行う。
ログイン状態を確認するAPIと、認証が必要なエンドポイントを保護するミドルウェアを提供する。
```

## 生成ルール

### 1. Vibe Coding リスク評価（最初に実施）

入力内容を分析し、以下の基準でリスクを評価してください：

| リスク  | 条件            | 対応                 |
|:-----|:--------------|:-------------------|
| 🔴 高 | 仕様書なし + 曖昧な指示 | 不足情報をユーザーに確認してから生成 |
| 🟡 中 | 一部の要件が曖昧      | 曖昧な箇所を明確化してから生成    |
| 🟢 低 | 要件が明確         | そのまま生成可能           |

**曖昧な入力の例**:

- 「いい感じに実装して」「適当に」→ 具体的な要件を確認
- 「パフォーマンスを上げて」→ 対象と目標値を確認
- 「前と同じように」→ 参照先を確認

### 2. 入力内容の分析

入力から以下を抽出・推測してください：

**Spec（抽象仕様書）用**:

| 抽出項目       | 説明                | 必須 |
|:-----------|:------------------|:---|
| **機能名**    | ファイル名に使用する識別名     | ✅  |
| **背景**     | なぜこの機能が必要か        | ✅  |
| **目的**     | 何を実現するか           | ✅  |
| **機能要件**   | 必要な機能のリスト         | ✅  |
| **公開API**  | ユーザーが使用するインターフェース |    |
| **データモデル** | 主要な型・エンティティ       |    |
| **振る舞い**   | 主要なユースケース・シーケンス   |    |

**Design Doc（技術設計書）用**:

| 抽出項目         | 説明               | 必須 |
|:-------------|:-----------------|:---|
| **技術スタック**   | 使用する技術・ライブラリ     | ✅  |
| **アーキテクチャ案** | モジュール構成・レイヤー設計   | ✅  |
| **設計判断**     | 技術選定の理由・代替案      |    |
| **非機能要件**    | パフォーマンス・セキュリティ要件 |    |

### 3. 不足情報の確認

入力から判断できない重要な項目がある場合、**生成前に**ユーザーに確認してください：

- 機能の名前が不明
- 必須の抽出項目が入力から推測できない
- 技術スタックの指定がない（既存パターンを踏襲するか確認）
- 曖昧なビジネスルールやエッジケース

### 4. 既存ドキュメントの確認

生成前に以下を確認してください。フラット構造と階層構造の両方をサポートします。

**フラット構造の場合**:

```
.sdd/requirement/{機能名}.md が存在するか？（PRD）
.sdd/specification/{機能名}_spec.md が既に存在するか？
.sdd/specification/{機能名}_design.md が既に存在するか？
```

**階層構造の場合**（親機能配下に配置する場合）:

```
.sdd/requirement/{親機能名}/index.md が存在するか？（親機能のPRD）
.sdd/requirement/{親機能名}/{機能名}.md が存在するか？（子機能のPRD）
.sdd/specification/{親機能名}/index_spec.md が既に存在するか？（親機能のspec）
.sdd/specification/{親機能名}/{機能名}_spec.md が既に存在するか？（子機能のspec）
.sdd/specification/{親機能名}/index_design.md が既に存在するか？（親機能のdesign）
.sdd/specification/{親機能名}/{機能名}_design.md が既に存在するか？（子機能のdesign）
```

**⚠️ 命名規則の違いに注意**:

- **requirement 配下**: サフィックスなし（`index.md`, `{機能名}.md`）
- **specification 配下**: `_spec` または `_design` サフィックス必須（`index_spec.md`, `{機能名}_spec.md`）

**階層構造の使用判断**:

- 対応するPRDが階層構造で存在する場合は、同じ階層構造を使用
- 入力に親機能（カテゴリ）が指定されている場合は階層構造を使用
- ユーザーに階層構造で配置するか確認することを推奨

**PRDが存在する場合**:

- PRDを事前に読み込み、要求ID（UR-xxx, FR-xxx, NFR-xxx）と機能要求を把握
- 生成するspecがPRDの要求を網羅するようにする
- specの「機能要件」セクションでPRDの要求IDを参照

**spec/designが存在する場合**: ユーザーに上書きするか確認してください。

## 出力形式

### Phase 1: 抽象仕様書（Specify フェーズ）

#### テンプレートの準備

以下の手順でテンプレートを準備してください：

1. `.sdd/SPECIFICATION_TEMPLATE.md` が存在するか確認
2. **存在する場合**: そのテンプレートを使用
3. **存在しない場合**: `sdd-workflow-ja:sdd-templates` スキルを使用して `.sdd/SPECIFICATION_TEMPLATE.md`
   を生成し、生成されたテンプレートを使用

#### テンプレート適用時の注意

- テンプレートのプレースホルダー（`{機能名}` など）を入力内容に基づいて置換
- `<MUST>` マーカーのセクションは必須、`<RECOMMENDED>` は推奨、`<OPTIONAL>` は任意
- PRDの要求ID（UR-xxx, FR-xxx, NFR-xxx）を機能要件で参照

**保存先**:

- フラット構造: `.sdd/specification/{機能名}_spec.md`
- 階層構造（親機能）: `.sdd/specification/{親機能名}/index_spec.md`
- 階層構造（子機能）: `.sdd/specification/{親機能名}/{機能名}_spec.md`

### Phase 2: 技術設計書（Plan フェーズ）

抽象仕様書の生成完了後、技術設計書を生成してください。

#### テンプレートの準備

以下の手順でテンプレートを準備してください：

1. `.sdd/DESIGN_DOC_TEMPLATE.md` が存在するか確認
2. **存在する場合**: そのテンプレートを使用
3. **存在しない場合**: `sdd-workflow-ja:sdd-templates` スキルを使用して `.sdd/DESIGN_DOC_TEMPLATE.md`
   を生成し、生成されたテンプレートを使用

#### テンプレート適用時の注意

- 実装ステータスは初期状態で「🔴 未実装」に設定
- 設計目標、技術スタック、アーキテクチャ、設計判断は必須セクション
- specとの整合性を確保

**保存先**:

- フラット構造: `.sdd/specification/{機能名}_design.md`
- 階層構造（親機能）: `.sdd/specification/{親機能名}/index_design.md`
- 階層構造（子機能）: `.sdd/specification/{親機能名}/{機能名}_design.md`

### Design Doc 生成をスキップする場合

以下の場合は Design Doc の生成をスキップし、ユーザーに確認してください：

- 入力に技術的な情報が全くない
- 既存の設計パターンを踏襲するか不明
- 調査・検討が必要な技術選定がある

## 生成フロー

```
1. 入力内容を分析
   ↓
2. プロジェクト原則の読み込み（必須）
   ├─ CONSTITUTION.md が存在する場合:
   │   └─ Read ツールで .sdd/CONSTITUTION.md を読み込む
   │   └─ 原則カテゴリ（B-xxx, A-xxx, D-xxx, T-xxx）を把握
   └─ 存在しない場合: スキップ（その旨を記録）
   ↓
3. Vibe Coding リスク評価
   ├─ 🔴 高: 不足情報をユーザーに確認 → 回答後に再開
   ├─ 🟡 中: 曖昧な箇所を確認 → 回答後に再開
   └─ 🟢 低: 次のステップへ
   ↓
4. 既存ドキュメントの確認
   ├─ PRDが存在する場合: 事前に読み込み、要求を把握
   └─ spec/designが存在する場合: 上書き確認
   ↓
5. 抽象仕様書を生成・保存（Specify）
   ↓
6. spec-reviewer による原則準拠チェック（必須）
   ├─ spec-reviewer エージェントを呼び出し（--summary オプション）
   ├─ **対象**: {機能名}_spec.md のみ（Design Docはまだ生成されていない）
   ├─ CONSTITUTION.md 準拠をチェック（アーキテクチャ・開発手法原則に焦点）
   ├─ PRD との整合性をチェック
   ├─ 違反検出時: 自動修正を試行
   └─ 修正後、再度チェック
   ↓
7. Design Doc 生成の確認
   ├─ 技術情報あり: 生成・保存（Plan）
   └─ 技術情報なし: スキップするか確認
   ↓
8. Design Doc の原則準拠チェック（Design Doc を生成した場合のみ）
   ├─ spec-reviewer エージェントを呼び出し（--summary オプション）
   ├─ **対象**: {機能名}_design.md のみ（Specは既にステップ6でチェック済み）
   ├─ CONSTITUTION.md 準拠をチェック（技術制約・アーキテクチャ原則に焦点）
   ├─ spec との整合性をチェック
   ├─ 違反検出時: 自動修正を試行
   └─ 修正後、再度チェック
```

## CONSTITUTION.md の読み込み（必須）

仕様書・設計書生成前に、**必ず Read ツールで `.sdd/CONSTITUTION.md` を読み込んでください**。

```
Read: .sdd/CONSTITUTION.md
```

### 読み込み後の確認事項

CONSTITUTION.md から以下の原則を把握し、生成時に準拠してください：

| 原則カテゴリ      | spec への影響                  | design への影響              |
|:------------|:---------------------------|:-------------------------|
| ビジネス原則（B-xxx） | 機能要件がビジネス原則と整合するか          | 設計判断がビジネス原則を尊重しているか      |
| アーキテクチャ原則（A-xxx） | API設計がアーキテクチャ原則に従っているか     | モジュール構成・技術スタックが原則に準拠しているか |
| 開発手法原則（D-xxx） | 機能要件が検証可能な形で記述されているか       | テスト戦略が Test-First に準拠しているか |
| 技術制約（T-xxx） | データモデルが技術制約を満たすか           | 実装方針が技術制約に準拠しているか        |

### CONSTITUTION.md が存在しない場合

1. **原則準拠チェックをスキップ**
2. **出力に記載**: "⚠️ CONSTITUTION.md が存在しないため、原則準拠チェックをスキップしました"
3. **ユーザーに推奨**: "`/sdd_init` または `/constitution init` を実行してプロジェクト原則を作成してください"
4. **仕様書・設計書生成は継続** (その他の品質チェックは通常通り実行)

## spec-reviewer による原則準拠チェック（必須）

仕様書・設計書生成後、**必ず `spec-reviewer` エージェントを呼び出して原則準拠をチェック**してください。

### チェックフロー

```
1. spec-reviewer エージェントを呼び出し
   ↓
2. CONSTITUTION.md 準拠チェックを実行
   ↓
3. PRD との整合性をチェック（PRD が存在する場合）
   ↓
4. 違反が検出された場合:
   ├─ 自動修正可能: Edit ツールで修正を適用
   └─ 自動修正不可能: 手動修正が必要な箇所をレポート
   ↓
5. 修正後、再度チェックして確認
   ↓
6. チェック結果を出力に含める
```

### チェック結果の出力

生成完了時に以下を出力に含めてください：

```markdown
### CONSTITUTION.md 準拠チェック結果

#### spec チェック結果

| 原則カテゴリ | 準拠状態 |
|:---|:---|
| ビジネス原則 | 🟢 準拠 / 🔴 違反 |
| アーキテクチャ原則 | 🟢 / 🔴 |
| 開発手法原則 | 🟢 / 🔴 |
| 技術制約 | 🟢 / 🔴 |

#### design チェック結果（生成した場合）

| 原則カテゴリ | 準拠状態 |
|:---|:---|
| ビジネス原則 | 🟢 準拠 / 🔴 違反 |
| アーキテクチャ原則 | 🟢 / 🔴 |
| 開発手法原則 | 🟢 / 🔴 |
| 技術制約 | 🟢 / 🔴 |

**自動修正**: {修正件数} 件
**手動修正が必要**: {件数} 件（詳細は上記参照）
```

## PRDとの整合性レビュー

PRDが存在する場合、生成したspecに対して以下の整合性チェックを行い、結果をspecに反映してください：

### チェック項目

| チェック項目       | 確認内容                               |
|:-------------|:-----------------------------------|
| **要求の網羅性**   | PRDの機能要求（FR-xxx）がすべてspecでカバーされているか |
| **要求IDの参照**  | specの機能要件でPRDの要求IDを適切に参照しているか      |
| **非機能要求の反映** | PRDの非機能要求（NFR-xxx）がspecに反映されているか   |
| **用語の一致**    | PRDとspecで同じ用語が使用されているか             |

### 不整合検出時の対応

1. **欠落している要求**: specに該当する機能要件を追加
2. **要求IDの未参照**: 機能要件に対応する要求IDを追記
3. **用語の不一致**: PRDの用語に統一

### 整合性レビュー結果の記載

specの末尾に以下を追記（PRDが存在する場合）：

````markdown
## PRD参照

- 対応PRD: `.sdd/requirement/[{親機能名}/]{機能名}.md`
- カバーする要求: UR-001, FR-001, FR-002, NFR-001, ...

````

※ 階層構造の場合、親機能のPRDは `.sdd/requirement/{親機能名}/index.md` を参照

## 生成後のアクション

1. **ファイル保存**:
    - フラット構造: `.sdd/specification/{機能名}_spec.md`、`.sdd/specification/{機能名}_design.md`
    - 階層構造（親機能）: `.sdd/specification/{親機能名}/index_spec.md`、`.sdd/specification/{親機能名}/index_design.md`
    - 階層構造（子機能）: `.sdd/specification/{親機能名}/{機能名}_spec.md`、`.sdd/specification/{親機能名}/{機能名}_design.md`

2. **整合性チェック**:
    - PRDが存在する場合: PRD ↔ spec の整合性を確認・反映
    - spec ↔ design の整合性を確認

## Serena MCP 統合（オプション）

Serena MCP が有効な場合、既存コードベースのセマンティック分析を活用して仕様書生成を強化できます。

### 利用条件

- `.mcp.json` に `serena` が設定されていること
- 対象言語の Language Server がサポートされていること

### Serena 有効時の追加機能

#### 既存コードからの仕様抽出

| 機能                         | 活用方法                        |
|:---------------------------|:----------------------------|
| `find_symbol`              | 既存の関数・クラス定義を検索し、API仕様の参考にする |
| `find_referencing_symbols` | 既存コードの使用パターンから振る舞いを推測       |

#### 生成強化項目

1. **既存API参照**: 類似機能の既存実装を参照し、一貫性のあるAPI設計を提案
2. **型定義の参照**: プロジェクト内の既存型を検索し、データモデルに反映
3. **命名規則の統一**: 既存コードの命名パターンを分析し、新機能の命名に反映
4. **依存関係の把握**: 関連モジュールを特定し、インターフェース設計に活用

#### 生成フローへの統合

```
1. 入力内容を分析
   ↓
2. [Serena有効時] 既存コードベースを分析
   ├─ 類似機能の検索
   ├─ 既存型・インターフェースの把握
   └─ 命名規則の抽出
   ↓
3. Vibe Coding リスク評価
   ...
```

### Serena 未設定時の動作

Serena が利用できない場合でも、入力内容とPRDに基づいて仕様書を生成します。
既存コードの参照は手動で行う必要があります。
