---
description: "実装コードと設計書（design）の整合性をチェックし、差異を検出する"
allowed-tools: Read, Glob, Grep, AskUserQuestion, Task
---

# Check Spec - 設計書・実装整合性チェック

実装コードと設計書（`*_design.md`）の整合性を確認し、差異を検出します。

**役割**: このコマンドは **design ↔ 実装の整合性チェック**に特化しています。
**ドキュメント間の整合性**（PRD ↔ spec、spec ↔ design）は `--full` オプションで
呼び出される `spec-reviewer` エージェントが担当します。

## 前提条件

**実行前に必ず `sdd-workflow-ja:sdd-workflow` エージェントの内容を読み込み、AI-SDDの原則を理解してください。**

このコマンドはsdd-workflowエージェントの原則に従って整合性チェックを行います。

### ディレクトリパスの解決

**環境変数 `SDD_*` を使用してディレクトリパスを解決します。**

| 環境変数                     | デフォルト値               | 説明              |
|:-------------------------|:---------------------|:----------------|
| `SDD_ROOT`               | `.sdd`               | ルートディレクトリ       |
| `SDD_REQUIREMENT_PATH`   | `.sdd/requirement`   | PRD/要求仕様書ディレクトリ |
| `SDD_SPECIFICATION_PATH` | `.sdd/specification` | 仕様書・設計書ディレクトリ   |
| `SDD_TASK_PATH`          | `.sdd/task`          | タスクログディレクトリ     |

**パス解決の優先順位:**

1. 環境変数 `SDD_*` が設定されている場合はそれを使用
2. 環境変数がない場合は `.sdd-config.json` を確認
3. どちらもない場合はデフォルト値を使用

以下のドキュメントでは、デフォルト値を使用して説明しますが、環境変数または設定ファイルが存在する場合はカスタム値に置き換えてください。

### ドキュメント間の依存関係（参照）

```
実装 → task/ → *_design.md → *_spec.md → requirement/ → CONSTITUTION.md
```

## 入力

$ARGUMENTS

### オプション

- `--full`: 整合性チェックに加えて、`spec-reviewer` エージェントによる品質レビューも実行します
    - CONSTITUTION.md 準拠チェック
    - 完全性・明確性・SysML準拠チェック
    - 曖昧な記述の検出

### 入力例

```
/check_spec user-auth              # 整合性チェックのみ（デフォルト）
/check_spec task-management --full # 整合性チェック + 品質レビュー
/check_spec --full                 # 全仕様書を対象に包括的チェック
/check_spec                        # 引数なしの場合は全仕様書を対象（整合性チェックのみ）
```

## 処理フロー

### 1. 対象ドキュメントの特定

設計書（`*_design.md`）を対象とします。フラット構造と階層構造の両方をサポートします。

**フラット構造の場合**:

```
引数あり → 以下のファイルを対象:
  - .sdd/specification/{引数}_design.md
引数なし → .sdd/specification/ 配下の全 *_design.md ファイルを対象（再帰的に検索）
```

**階層構造の場合**（引数に `/` が含まれる場合、または階層パスを指定）:

```
引数が "{親機能名}/{機能名}" の形式 → 以下のファイルを対象:
  - .sdd/specification/{親機能名}/{機能名}_design.md

引数が "{親機能名}" のみの場合 → 以下のファイルを対象:
  - .sdd/specification/{親機能名}/index_design.md（親機能のdesign）
  - .sdd/specification/{親機能名}/*_design.md（子機能のdesign）
```

**⚠️ 命名規則**:

- **specification 配下**: `_design` サフィックス必須（`index_design.md`, `{機能名}_design.md`）

**入力例（階層構造）**:

```
/check_spec auth/user-login     # 認証ドメイン配下のユーザーログイン機能をチェック
/check_spec auth                # 認証ドメイン全体をチェック
```

### 2. 設計書の読み込み

**`*_design.md` から以下の情報を抽出**:

| 項目             | 説明                                    |
|:---------------|:--------------------------------------|
| **モジュール構成**    | ディレクトリ構造、ファイル構成                       |
| **技術スタック**     | 使用ライブラリ、フレームワーク                       |
| **インターフェース定義** | API シグネチャ（関数名、引数、戻り値）、型定義、データモデル      |
| **機能要件**       | 実装すべき機能の一覧                            |
| **実装方針**       | アーキテクチャパターン、設計判断                      |

### 3. 実装コードの確認

仕様書に記載された内容に対応するコードを検索：

- API・関数の検索（プロジェクトの言語に応じた方法で検索）
- 型定義・データモデルの検索
- モジュール・ファイルの存在確認

### 4. 整合性チェック項目

**注意**: このコマンドは**design ↔ 実装の整合性チェック**に特化しています。**ドキュメント間の整合性**
（PRD ↔ spec、spec ↔ design）および**品質レビュー**（CONSTITUTION.md準拠、完全性、明確性）は
`--full` オプションで `spec-reviewer` エージェントが担当します。

#### design ↔ 実装 の整合性

| チェック対象        | 確認内容                | 重要度 |
|:--------------|:--------------------|:----|
| **API シグネチャ** | 関数名、引数、戻り値が一致するか    | 高   |
| **型定義**       | インターフェース、型が一致するか    | 高   |
| **モジュール構成**   | ディレクトリ・ファイル構造が一致するか | 中   |
| **機能要件**      | 仕様に記載された機能が実装されているか | 高   |
| **技術スタック**    | 記載されたライブラリが使用されているか | 低   |

### 5. 差異の分類

検出した差異を以下のように分類：

**🔴 Critical（即座に対応が必要）**:

- APIシグネチャの不一致（引数、戻り値の型）
- 仕様に記載された機能が未実装
- 型定義の不一致

**🟡 Warning（対応推奨）**:

- モジュール構成の不一致
- ドキュメントに記載のないクラス・関数の存在
- 命名規則の不一致

**🟢 Info（参考情報）**:

- 技術スタックの軽微な差異
- コメント・ドキュメントの不足

### 6. 包括的レビュー（--fullオプション指定時のみ）

`--full` オプションが指定された場合、`spec-reviewer` エージェントを呼び出して包括的なレビューを実施します。

#### レビュー内容

| チェック項目                   | 説明                                      |
|:--------------------------|:----------------------------------------|
| **PRD ↔ spec トレーサビリティ**  | PRDの要求がspecでカバーされているか確認（カバレッジ80%閾値） |
| **spec ↔ design 整合性**     | specの内容がdesignで適切に詳細化されているか確認         |
| **CONSTITUTION.md 準拠**    | プロジェクト原則への準拠状況を確認                     |
| **完全性**                   | 必須セクション（目的、API、制約事項等）が揃っているか確認       |
| **明確性**                   | 曖昧な記述（「いい感じに」「適当に」等）を検出              |
| **SysML準拠**               | 要求ID形式（UR/FR/NFR-xxx）やトレーサビリティが適切か   |

#### 実行タイミング

- design ↔ 実装の整合性チェック完了後に実行
- 対象となるドキュメント（PRD、spec、design）に対して包括的レビューを実施
- トレーサビリティマトリックス生成（PRD → spec → design の対応関係）

**注意**: 包括的レビューは追加の実行時間を要します。開発中の素早い確認には `--full` なしで実行し、PR作成前や定期チェックで
`--full` を使用することを推奨します。

## 出力フォーマット

````markdown
## 設計書・実装整合性チェック結果

### 対象ドキュメント

- `.sdd/specification/[{親機能名}/]{機能名}_design.md`

※ 階層構造の場合、親機能は `index_design.md`

### チェック結果サマリー

**design ↔ 実装の整合性チェック**:

| チェック対象      | 結果           | 件数    |
|:------------|:-------------|:------|
| design ↔ 実装 | 🟢 整合 / 🔴 不整合 | {n} 件 |

**ドキュメント間整合性・品質レビュー**（`--full` オプション指定時のみ）:

`spec-reviewer` エージェントによる包括的なレビュー結果が以下に表示されます。

| 観点                    | 結果           | 件数    |
|:----------------------|:-------------|:------|
| PRD ↔ spec トレーサビリティ | 🟢 整合 / 🔴 不整合 | {n} 件 |
| spec ↔ design 整合性    | 🟢 整合 / 🔴 不整合 | {n} 件 |
| CONSTITUTION.md 準拠    | 🟢 準拠 / 🔴 違反 | {n} 件 |
| 完全性                   | ✅ 良好 / ⚠️ 要改善 | {n} 件 |
| 明確性                   | ✅ 良好 / ⚠️ 要改善 | {n} 件 |

### 🔴 Critical（即座に対応が必要）

#### 1. {差異のタイトル}

**仕様書の記載**:

```

// *_spec.md より
doSomething(arg: 文字列): Result

```

**実装コード**:

```

// 実装ファイルより
doSomething(arg: 数値): Result // 引数の型が異なる

```

**推奨アクション**:

- [ ] 仕様書を更新する（実装が正しい場合）
- [ ] 実装を修正する（仕様書が正しい場合）

---

### 🟡 Warning（対応推奨）

#### 1. {差異のタイトル}

**内容**: {差異の詳細}

**推奨アクション**: {対応方法}

---

### 🟢 Info（参考情報）

- {情報1}
- {情報2}

---

### 未実装機能

仕様書に記載されているが、実装が確認できなかった機能：

| 機能    | 仕様書の記載箇所              | ステータス  |
|:------|:----------------------|:-------|
| {機能名} | `*_spec.md` の {セクション} | 🔴 未実装 |

### 仕様書に未記載の実装

実装されているが、仕様書に記載がない機能：

| 実装         | ファイル       | 推奨アクション         |
|:-----------|:-----------|:----------------|
| {関数名/クラス名} | `{ファイルパス}` | 仕様書に追記 / 不要なら削除 |

---

### 品質レビュー結果（--fullオプション指定時のみ）

#### 仕様書品質スコア

| ドキュメント                        | CONSTITUTION準拠 | 完全性 | 明確性 | SysML準拠 | 総合評価         |
|:------------------------------|:--------------|:-----|:-----|:--------|:-------------|
| `.sdd/specification/{機能名}_spec.md` | 🟢 準拠 / 🔴 違反   | ✅ / ⚠️ | ✅ / ⚠️ | ✅ / ⚠️   | 🟢 良好 / 🟡 要改善 |
| `.sdd/specification/{機能名}_design.md` | 🟢 準拠 / 🔴 違反   | ✅ / ⚠️ | ✅ / ⚠️ | -       | 🟢 良好 / 🟡 要改善 |

#### 検出された問題

##### 🔴 CONSTITUTION.md 違反（{n}件）

- **違反内容**: {プロジェクト原則に違反している内容}
- **該当箇所**: `{ファイル名}` の {セクション}
- **推奨修正**: {どのように修正すべきか}

##### 🟡 完全性の問題（{n}件）

- **不足セクション**: {必須セクション名}
- **該当ファイル**: `{ファイル名}`
- **推奨アクション**: セクションを追加し、{内容}を記載

##### 🟡 曖昧な記述（{n}件）

- **曖昧な表現**: 「{検出された曖昧な表現}」
- **該当箇所**: `{ファイル名}` の {セクション}
- **推奨修正**: 具体的な基準や実装方針を明記

**注意**: 上記は簡易サマリーです。詳細なレビュー結果（原則違反の詳細、自動修正サマリー等）は、spec-reviewerエージェントから個別に出力されます。

---

### 推奨アクション

#### 優先順位

1. **Critical の差異を優先的に解消**
    - APIシグネチャの不一致（引数、戻り値の型）
    - 設計書に記載された機能の未実装
    - 型定義の不一致

2. **Warning の対応**
    - モジュール構成の整合性確保
    - 設計書に未記載の実装の文書化

3. **Info の確認**
    - 技術スタックの軽微な差異
    - ドキュメント改善の検討

4. **ドキュメント間整合性の確認**（`--full` オプション実行時）
    - spec-reviewer が検出したドキュメント間の不整合を確認
    - PRD ↔ spec ↔ design の整合性を確保

#### 対応フロー

1. design ↔ 実装の不整合を確認し、差異の原因を特定
2. 設計書または実装のどちらを修正するか判断:
    - 実装が正しい場合 → 設計書を更新
    - 設計書が正しい場合 → 実装を修正
3. `--full` オプション実行時は、spec-reviewer の指摘も確認:
    - PRD ↔ spec の不整合
    - spec ↔ design の不整合
    - CONSTITUTION.md 違反
4. 修正後、再度 `/check_spec` を実行して確認

````

## チェック実行タイミング

| タイミング      | 推奨アクション       |
|:-----------|:--------------|
| **実装開始前**  | 仕様書の存在と内容を確認  |
| **実装完了時**  | 仕様との整合性を検証    |
| **PR作成前**  | 最終確認として実行     |
| **定期チェック** | ドキュメントの陳腐化を防止 |

## Serena MCP 統合（オプション）

Serena MCP が有効な場合、セマンティックコード分析による高精度な整合性チェックが可能です。

### 利用条件

- `.mcp.json` に `serena` が設定されていること
- 対象言語の Language Server がサポートされていること（30以上の言語に対応）

### Serena 有効時の追加機能

#### シンボルベースの整合性チェック

| 機能                         | 説明                         |
|:---------------------------|:---------------------------|
| `find_symbol`              | specに記載されたAPI/関数を実装コードから検索 |
| `find_referencing_symbols` | 特定シンボルの使用箇所を把握し、影響範囲を特定    |

#### チェック強化項目

1. **API実装の検証**: specに記載された関数・クラスが実装されているかシンボル検索で確認
2. **シグネチャの一致**: 関数の引数・戻り値の型がspecと一致するか検証
3. **未使用コードの検出**: 実装されているがspecに記載のないシンボルを検出
4. **依存関係の把握**: モジュール間の参照関係を分析

#### Serena 利用時の出力追加

````markdown
### Serena シンボル分析結果

| シンボル             | spec記載 | 実装状況   | 参照数 |
|:-----------------|:-------|:-------|:----|
| `createUser`     | ✅      | ✅ 実装済み | 5   |
| `deleteUser`     | ✅      | 🔴 未実装 | 0   |
| `internalHelper` | ❌      | ✅ 実装済み | 3   |
````

### Serena 未設定時の動作

Serena が利用できない場合でも、従来のテキストベース検索（Grep/Glob）で整合性チェックを実行します。
機能は制限されますが、言語非依存で動作します。

## 注意事項

- 仕様書が存在しない場合は、先に `/generate_spec` で作成を推奨
- 差異が多い場合は、仕様書の大幅な更新が必要な可能性あり
- 実装が正しく仕様書が古い場合は、仕様書を更新
- 仕様書が正しく実装が誤っている場合は、実装を修正
