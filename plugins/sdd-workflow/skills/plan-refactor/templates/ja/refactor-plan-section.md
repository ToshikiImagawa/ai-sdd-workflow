## リファクタリング計画

### 目的と背景

**リファクタリングが必要な理由:**

{EXPLAIN_MOTIVATION}

**ビジネス/技術的な推進要因:**

- {要因1: 例: スケールのためのパフォーマンス改善が必要}
- {要因2: 例: コードの保守性の問題}
- {要因3: 例: 新機能のためにアーキテクチャ変更が必要}

### 現状分析

**特定された問題:**

1. **{問題1タイトル}** (深刻度: {高/中/低})
    - 説明: {詳細な説明}
    - 影響: {開発/ユーザーへの影響}
    - 場所: `{file_path}:{line_range}`

2. **{問題2タイトル}** (深刻度: ...)
    - 説明: ...
    - 影響: ...
    - 場所: ...

**コード品質メトリクス（取得可能な場合）:**

- 循環的複雑度: {値}
- コード重複: {パーセンテージ}
- テストカバレッジ: {パーセンテージ}
- 技術的負債比率: {推定値}

**根本原因分析:**

{DEEPER_ANALYSIS_OF_WHY_PROBLEMS_EXIST}

### リファクタリング戦略

**ゴール:**

1. {ゴール1: 例: 認証モジュールと認可モジュール間の結合度を下げる}
2. {ゴール2: 例: 依存性注入を導入してテスト容易性を向上}
3. {ゴール3: 例: エラー処理のコード重複を排除}

**アプローチ:**

- **パターン:** {例: インターフェース抽出、ストラテジーパターン、リポジトリパターン}
- **技法:** {例: 段階的移行のためのStrangler Figパターン}
- **参考資料:**
    - `references/refactor-patterns.md` でパターンの詳細を参照
    - Martin Fowlerのリファクタリングカタログ: {具体的なリファクタリング}

**トレードオフ:**

| 側面      | Before | After | トレードオフ |
|:--------|:-------|:------|:-------|
| 複雑性     | {値}    | {値}   | {説明}   |
| パフォーマンス | {値}    | {値}   | {説明}   |
| テスト容易性  | {値}    | {値}   | {説明}   |

### 移行計画

**フェーズ1: 準備** (見積: {期間})

- **タスク1.1:** 現在の振る舞いに対する包括的なユニットテストを追加
    - ファイル: {リスト}
    - 受け入れ基準: {基準}

- **タスク1.2:** 現在のAPIコントラクトを文書化
    - インターフェース定義を作成
    - エッジケースを文書化

- **タスク1.3:** フィーチャーフラグの設定（段階的ロールアウトが必要な場合）
    - ツール: {例: LaunchDarkly、カスタム}

**フェーズ2: リファクタリング** (見積: {期間})

- **タスク2.1:** {具体的なリファクタリングタスク}
    - 変更対象ファイル: {リスト}
    - 予想される変更: {説明}

- **タスク2.2:** {次のリファクタリングタスク}
    - ...

- **タスク2.3:** 新しい構造を反映するようテストを更新
    - ...

**フェーズ3: 検証** (見積: {期間})

- **タスク3.1:** 既存のすべてのテストがパスすることを確認
    - コマンド: `{test_command}`

- **タスク3.2:** パフォーマンスベンチマーク（前後比較）
    - メトリクス: {レイテンシ、スループット、メモリ}
    - ツール: {ベンチマークツール}

- **タスク3.3:** コードレビューと承認
    - レビュアー: {チームメンバー}

- **タスク3.4:** 非推奨コードとフィーチャーフラグを削除
    - 古い実装をクリーンアップ

**フェーズ4: デプロイ** (見積: {期間})

- **タスク4.1:** ステージング環境へデプロイ
- **タスク4.2:** ステージングでのスモークテスト
- **タスク4.3:** 本番環境への段階的ロールアウト（該当する場合）
- **タスク4.4:** {期間}メトリクスを監視

### 影響分析

**破壊的変更:**

- [ ] なし（後方互換性あり）
- [ ] 内部APIのみ（外部への影響なし）
- [ ] パブリックAPIの変更（バージョン更新と移行ガイドが必要）

**影響を受けるコンポーネント:**

| コンポーネント            | タイプ    | 影響            | 緩和策             |
|:-------------------|:-------|:--------------|:----------------|
| `{component_name}` | {type} | {description} | {how_to_handle} |

**影響を受けるステークホルダー:**

- **開発者:** {影響と必要なアクション}
- **QA/テスター:** {影響と必要なアクション}
- **エンドユーザー:** {影響、もしあれば}
- **運用チーム:** {影響、もしあれば}

**依存関係:**

- 必要: {他の機能、マイグレーション、インフラ変更}
- ブロックする: {これが完了するまで進められない機能}

**ロールバック計画:**

デプロイ後に重大な問題が発見された場合:

1. {ステップ1: 例: gitタグを使って前バージョンに戻す}
2. {ステップ2: 例: 古い実装のフィーチャーフラグを再有効化}
3. {ステップ3: 例: ステークホルダーに通知}

**ロールバックトリガー基準:**

- {基準1: 例: エラー率 > 5%}
- {基準2: 例: P95レイテンシ > ベースラインの2倍}

### テスト戦略

**ユニットテスト:**

- {テストシナリオ1}
    - 場所: `{test_file_path}`
    - ステータス: [ ] 作成予定 / [ ] 既存

- {テストシナリオ2}
    - ...

**統合テスト:**

- {統合テストシナリオ1}
    - ...

**E2Eテスト:**

- {E2Eテストシナリオ1}
    - ...

**手動テストチェックリスト:**

- [ ] {手動テスト項目1}
- [ ] {手動テスト項目2}
- [ ] 後方互換性の確認（該当する場合）
- [ ] パフォーマンス検証（前後比較）

**リグレッションテスト:**

- フルテストスイートを実行: `{command}`
- 期待される結果: 新たな失敗なしですべてのテストがパス

### 成功基準

**メトリクス:**

| メトリクス       | 現在   | 目標   | 測定方法  |
|:------------|:-----|:-----|:------|
| コード複雑性      | {値}  | {値}  | {ツール} |
| テストカバレッジ    | {値}% | {値}% | {ツール} |
| 重複          | {値}% | {値}% | {ツール} |
| ビルド時間       | {値}  | {値}  | CIログ  |
| {カスタムメトリクス} | {値}  | {値}  | {方法}  |

**定性的ゴール:**

- [ ] コードが理解しやすくなった（チームフィードバックに基づく）
- [ ] 新機能をより迅速に追加できるようになった
- [ ] このモジュールのバグ頻度が減少した

**受け入れ基準:**

- [ ] 既存のすべての機能が保持されている
- [ ] すべてのテストがパス
- [ ] {N}人のエンジニアによるコードレビュー承認
- [ ] パフォーマンスメトリクスが許容範囲内
- [ ] ドキュメントが更新されている

### リスクと緩和策

| リスク                  | 可能性     | 影響      | 緩和策    |
|:---------------------|:--------|:--------|:-------|
| {リスク1: 例: リグレッションバグ} | {高/中/低} | {高/中/低} | {緩和戦略} |
| {リスク2: 例: パフォーマンス劣化} | {高/中/低} | {高/中/低} | {緩和戦略} |

### タイムラインとマイルストーン

| マイルストーン   | 目標日    | 担当者    | ステータス   |
|:----------|:-------|:-------|:--------|
| フェーズ1完了   | {date} | {name} | [ ] 未着手 |
| フェーズ2完了   | {date} | {name} | [ ] 未着手 |
| フェーズ3完了   | {date} | {name} | [ ] 未着手 |
| 本番環境へデプロイ | {date} | {name} | [ ] 未着手 |

### 参考資料

- 関連PRD: `{path_to_prd}`
- 関連仕様書: `{path_to_spec}`
- デザインパターン: `references/refactor-patterns.md` を参照
- 統合ガイド: `references/design-doc-integration.md` を参照

---

**最終更新:** {DATE}
**作成者:** Claude Code (AI-SDD plan-refactorスキル)
